================================================================================
                    10 - SISTEMA DE EMAILS
                         E-COMMERCE DE JOYERÃA
                    EXPLICACIÃ“N DETALLADA Y DIDÃCTICA
================================================================================

Â¿QUÃ‰ ES UN SISTEMA DE EMAILS?

Imagina que tienes una tienda fÃ­sica. Cuando un cliente compra algo, le das:
- Un recibo impreso
- Le dices cuÃ¡ndo llegarÃ¡ su pedido
- Le das tu nÃºmero de telÃ©fono por si tiene problemas

En una tienda ONLINE, no puedes hacer eso fÃ­sicamente. Entonces usas EMAILS:
- Email de confirmaciÃ³n = Recibo digital
- Email de envÃ­o = "Tu pedido va en camino"
- Email de entrega = "Tu pedido llegÃ³"
- Email de bienvenida = "Gracias por registrarte"

Un Sistema de Emails es como tener un asistente automÃ¡tico que envÃ­a estos
emails en el momento correcto, sin que tÃº tengas que hacerlo manualmente.

================================================================================
Â¿POR QUÃ‰ ES TAN IMPORTANTE?
================================================================================

Desde el punto de vista del USUARIO:
- âœ… "Â¿Se registrÃ³ mi cuenta?" â†’ Email de bienvenida lo confirma
- âœ… "Â¿Se procesÃ³ mi compra?" â†’ Email de confirmaciÃ³n lo confirma
- âœ… "Â¿CuÃ¡ndo llega mi pedido?" â†’ Email de envÃ­o con tracking
- âœ… "OlvidÃ© mi contraseÃ±a" â†’ Email para recuperarla

Desde el punto de vista del NEGOCIO:
- âœ… Reduce llamadas al soporte (menos preguntas repetitivas)
- âœ… Genera confianza (el cliente sabe que todo estÃ¡ bien)
- âœ… Mejora la reputaciÃ³n (se ve profesional)
- âœ… Aumenta ventas (emails bien hechos = clientes contentos = recomendaciones)

EJEMPLO REAL:
Sin emails: Cliente compra â†’ Espera 3 dÃ­as â†’ Se preocupa â†’ Llama a soporte
Con emails: Cliente compra â†’ Email inmediato â†’ Email cuando se envÃ­a â†’ Cliente tranquilo

================================================================================
TIPOS DE EMAILS QUE VAMOS A IMPLEMENTAR
================================================================================

Vamos a crear 5 tipos diferentes de emails. Cada uno tiene un propÃ³sito especÃ­fico.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. EMAIL DE BIENVENIDA ğŸ‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

CUÃNDO SE ENVÃA:
Cuando un usuario nuevo se registra en tu tienda.

EJEMPLO EN LA VIDA REAL:
Es como cuando entras a una tienda fÃ­sica y el vendedor te dice:
"Â¡Bienvenido! Soy Juan, si necesitas ayuda aquÃ­ estarÃ©"

QUÃ‰ CONTIENE:
- Saludo personalizado: "Hola MarÃ­a" (no "Hola usuario123")
- Mensaje de bienvenida amigable
- Links para explorar productos
- Email de soporte por si tiene dudas

POR QUÃ‰ ES IMPORTANTE:
- Primera impresiÃ³n (como un apretÃ³n de manos)
- Confirma que el registro fue exitoso
- GuÃ­a al usuario sobre quÃ© hacer despuÃ©s
- Genera confianza desde el inicio

CÃ“DIGO DONDE SE ENVÃA:
AuthController.java â†’ mÃ©todo register()
Justo despuÃ©s de crear el usuario en la base de datos

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
2. EMAIL DE CONFIRMACIÃ“N DE ORDEN ğŸ“¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

CUÃNDO SE ENVÃA:
Inmediatamente despuÃ©s de que el usuario finaliza una compra.

EJEMPLO EN LA VIDA REAL:
Es como el recibo que te dan en una tienda fÃ­sica, pero digital y mÃ¡s bonito.

QUÃ‰ CONTIENE:
- NÃºmero de orden (#12345)
- Lista de productos comprados (con cantidades y precios)
- Precio total
- DirecciÃ³n de envÃ­o
- Link para ver el detalle de la orden

POR QUÃ‰ ES IMPORTANTE:
- Confirma que la compra se procesÃ³ correctamente
- El cliente puede guardar este email como comprobante
- Reduce ansiedad ("Â¿se habrÃ¡ procesado mi compra?")
- Sirve como referencia para reclamos o devoluciones

EJEMPLO DE CONTENIDO:
"Hola MarÃ­a,
Â¡Gracias por tu compra!
Orden #12345
- Anillo de Oro 18K x1 = $15,000
- Collar de Plata x2 = $8,000
Total: $23,000
DirecciÃ³n de envÃ­o: Calle Falsa 123, Ciudad"

CÃ“DIGO DONDE SE ENVÃA:
OrderService.java â†’ mÃ©todo createOrder()
Justo despuÃ©s de guardar la orden en la base de datos

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
3. EMAIL DE NOTIFICACIÃ“N DE ENVÃO ğŸšš
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

CUÃNDO SE ENVÃA:
Cuando cambias el estado de una orden a "SHIPPED" (enviado).

EJEMPLO EN LA VIDA REAL:
Es como cuando el vendedor te llama y dice:
"MarÃ­a, tu pedido ya saliÃ³ de nuestra bodega y va en camino"

QUÃ‰ CONTIENE:
- ConfirmaciÃ³n de que el paquete fue enviado
- NÃºmero de tracking (para rastrear el paquete)
- DirecciÃ³n de entrega
- Link para rastrear el paquete en tiempo real

POR QUÃ‰ ES IMPORTANTE:
- El cliente sabe que su pedido estÃ¡ en camino (no perdido)
- Puede planear estar en casa para recibirlo
- Reduce preguntas al soporte: "Â¿dÃ³nde estÃ¡ mi pedido?"
- Genera expectativa positiva

EJEMPLO DE CONTENIDO:
"Hola MarÃ­a,
Â¡Buenas noticias! Tu orden #12345 fue enviada.
NÃºmero de rastreo: FED123456789MX
Entrega estimada: 3-5 dÃ­as hÃ¡biles
Puedes rastrear tu paquete aquÃ­: [link]"

CÃ“DIGO DONDE SE ENVÃA:
OrderService.java â†’ mÃ©todo updateOrderStatus()
Cuando el estado cambia a SHIPPED

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
4. EMAIL DE NOTIFICACIÃ“N DE ENTREGA âœ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

CUÃNDO SE ENVÃA:
Cuando cambias el estado de una orden a "DELIVERED" (entregado).

EJEMPLO EN LA VIDA REAL:
Es como cuando el vendedor confirma: "MarÃ­a, tu pedido llegÃ³ a tu casa"

QUÃ‰ CONTIENE:
- ConfirmaciÃ³n de que el paquete fue entregado
- Agradecimiento por la compra
- InvitaciÃ³n a dejar una reseÃ±a (feedback)
- Link para calificar el producto

POR QUÃ‰ ES IMPORTANTE:
- Cierra el ciclo de la compra (todo saliÃ³ bien)
- Genera feedback (reseÃ±as mejoran tu tienda)
- Muestra que te importa la satisfacciÃ³n del cliente
- Aumenta probabilidad de recompra

EJEMPLO DE CONTENIDO:
"Hola MarÃ­a,
Â¡Tu orden #12345 ha sido entregada!
Esperamos que disfrutes tus nuevas joyas ğŸ’
Â¿Nos cuentas tu experiencia? Deja una reseÃ±a: [link]
Si tienes algÃºn problema, contÃ¡ctanos."

CÃ“DIGO DONDE SE ENVÃA:
OrderService.java â†’ mÃ©todo updateOrderStatus()
Cuando el estado cambia a DELIVERED

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
5. EMAIL DE RECUPERACIÃ“N DE CONTRASEÃ‘A ğŸ”
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

CUÃNDO SE ENVÃA:
Cuando el usuario hace click en "OlvidÃ© mi contraseÃ±a".

EJEMPLO EN LA VIDA REAL:
Es como cuando olvidas la combinaciÃ³n de tu locker y el encargado te da
una llave temporal que solo funciona una vez y por tiempo limitado.

QUÃ‰ CONTIENE:
- Link especial para crear nueva contraseÃ±a
- Token temporal (vÃ¡lido solo 1 hora)
- Instrucciones claras de quÃ© hacer
- Advertencia de seguridad

POR QUÃ‰ ES IMPORTANTE:
- Los usuarios SIEMPRE olvidan contraseÃ±as
- Sin esto, pierdes clientes (no pueden entrar a su cuenta)
- Reduce tickets de soporte dramÃ¡ticamente
- Es una funcionalidad ESPERADA en cualquier app moderna

EJEMPLO DE CONTENIDO:
"Hola MarÃ­a,
Recibimos una solicitud para cambiar tu contraseÃ±a.
Haz click aquÃ­ para crear una nueva: [link con token]
Este link expira en 1 hora.
Si no fuiste tÃº, ignora este email."

CÃ“DIGO DONDE SE ENVÃA:
PasswordResetService.java â†’ mÃ©todo requestPasswordReset()
Cuando el usuario solicita recuperar su contraseÃ±a

NOTA IMPORTANTE SOBRE ESTE EMAIL:
Este email lo vamos a ver en DETALLE en los apuntes 11, porque tiene
su propia lÃ³gica compleja (tokens, expiraciÃ³n, validaciÃ³n, etc.)

================================================================================
RESUMEN DE LOS 5 EMAILS
================================================================================

Email                  CuÃ¡ndo                  Para QuÃ©
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ‰ Bienvenida          Al registrarse         Dar bienvenida + guiar
ğŸ“¦ ConfirmaciÃ³n        Al comprar             Confirmar compra + recibo
ğŸšš EnvÃ­o               Al enviar paquete      Informar tracking
âœ… Entrega             Al entregar            Confirmar + pedir reseÃ±a
ğŸ” RecuperaciÃ³n        Al olvidar contraseÃ±a  Permitir cambio seguro

Todos estos emails se envÃ­an AUTOMÃTICAMENTE en el momento correcto.
El usuario NO tiene que pedirlos, simplemente suceden.

================================================================================
CONFIGURACIÃ“N DE GMAIL
================================================================================

PASO 1: Activar VerificaciÃ³n en 2 Pasos
1. Ve a https://myaccount.google.com/security
2. Click en "VerificaciÃ³n en dos pasos"
3. Sigue los pasos para activarla

PASO 2: Generar App Password
1. Ve a https://myaccount.google.com/apppasswords
2. Selecciona "Correo"
3. Selecciona "Otro (nombre personalizado)"
4. Escribe: "Joyeria API"
5. Click "Generar"
6. COPIA la contraseÃ±a de 16 caracteres (sin espacios)

âš ï¸ IMPORTANTE:
- NO uses tu contraseÃ±a normal de Gmail
- DEBES usar una App Password
- La App Password es de 16 caracteres
- Quita los espacios al copiarla

PASO 3: Configurar en application.properties

spring.mail.host=smtp.gmail.com
spring.mail.port=587
spring.mail.username=tu-email@gmail.com
spring.mail.password=abcdefghijklmnop  # â† App Password SIN espacios
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.properties.mail.smtp.starttls.required=true

# Email del remitente (DEBE ser el mismo que spring.mail.username)
app.email.from=JoyerÃ­a E-commerce <tu-email@gmail.com>
app.email.support=tu-email@gmail.com
app.frontend.url=http://localhost:3000

================================================================================
ESTRUCTURA DE ARCHIVOS
================================================================================

src/main/java/com/joyeria/
â”œâ”€â”€ exception/
â”‚   â”œâ”€â”€ EmailSendException.java              âœ… Error al enviar email
â”‚   â”œâ”€â”€ InvalidEmailException.java           âœ… Email invÃ¡lido
â”‚   â””â”€â”€ EmailConfigurationException.java     âœ… Email no configurado
â”œâ”€â”€ service/
â”‚   â””â”€â”€ EmailService.java                    âœ… Servicio de emails
â”œâ”€â”€ config/
â”‚   â””â”€â”€ AsyncConfig.java                     âœ… Habilita envÃ­o asÃ­ncrono
â””â”€â”€ controller/
    â”œâ”€â”€ AuthController.java                  âœ… Llama sendWelcomeEmail()
    â””â”€â”€ OrderService.java                    âœ… Llama sendOrderConfirmation()

================================================================================
DEPENDENCIA EN POM.XML
================================================================================

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>

================================================================================
EXCEPCIONES DE EMAIL
================================================================================

1. EmailSendException
   - CuÃ¡ndo se lanza: Falla el envÃ­o del email (SMTP, red)
   - Status HTTP: 503 Service Unavailable
   - Uso: Cuando mailSender.send() falla

public class EmailSendException extends RuntimeException {
    public EmailSendException(String recipient, String emailType, Throwable cause) {
        super(String.format("Error al enviar email de tipo '%s' a '%s': %s", 
            emailType, recipient, cause.getMessage()), cause);
    }
}

2. InvalidEmailException
   - CuÃ¡ndo se lanza: Email con formato invÃ¡lido
   - Status HTTP: 400 Bad Request
   - Uso: Cuando el email no pasa validaciÃ³n de regex

public class InvalidEmailException extends RuntimeException {
    public InvalidEmailException(String email) {
        super(String.format("El email '%s' no es vÃ¡lido", email));
    }
}

3. EmailConfigurationException
   - CuÃ¡ndo se lanza: Email no configurado en properties
   - Status HTTP: 500 Internal Server Error
   - Uso: Cuando spring.mail.username estÃ¡ vacÃ­o

public class EmailConfigurationException extends RuntimeException {
    public EmailConfigurationException(String message) {
        super("Error de configuraciÃ³n de email: " + message);
    }
}

================================================================================
EMAILSERVICE.JAVA - SERVICIO PRINCIPAL
================================================================================

@Service
@RequiredArgsConstructor
@Slf4j
public class EmailService {
    
    private final JavaMailSender mailSender;
    
    @Value("${app.email.from}")
    private String emailFrom;
    
    @Value("${app.email.support}")
    private String emailSupport;
    
    @Value("${app.frontend.url}")
    private String frontendUrl;
    
    // PatrÃ³n para validar emails
    private static final Pattern EMAIL_PATTERN = Pattern.compile(
        "^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$"
    );
    
    // Verificar configuraciÃ³n al iniciar
    @PostConstruct
    public void init() {
        if (mailUsername == null || mailUsername.isEmpty()) {
            log.warn("âš ï¸ Email no configurado. Los emails NO se enviarÃ¡n.");
        } else {
            log.info("âœ… Email configurado: {}", mailUsername);
        }
    }
    
    // Validar formato de email
    private void validateEmail(String email) {
        if (email == null || email.trim().isEmpty()) {
            throw new InvalidEmailException("El email no puede estar vacÃ­o");
        }
        
        if (!EMAIL_PATTERN.matcher(email).matches()) {
            throw new InvalidEmailException(email);
        }
    }
    
    // Verificar configuraciÃ³n
    private void checkEmailConfiguration() {
        if (mailUsername == null || mailUsername.isEmpty()) {
            throw new EmailConfigurationException(
                "El servicio de email no estÃ¡ configurado"
            );
        }
    }
    
    // Enviar email de bienvenida
    @Async
    public void sendWelcomeEmail(User user) {
        try {
            validateEmail(user.getEmail());
            checkEmailConfiguration();
            
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");
            
            helper.setFrom(emailFrom);
            helper.setTo(user.getEmail());
            helper.setSubject("Â¡Bienvenido a JoyerÃ­a E-commerce! ğŸ’");
            
            String htmlContent = buildWelcomeEmail(user);
            helper.setText(htmlContent, true);
            
            mailSender.send(message);
            log.info("âœ… Email de bienvenida enviado a: {}", user.getEmail());
            
        } catch (Exception e) {
            log.error("âŒ Error enviando email: {}", e.getMessage());
            throw new EmailSendException(user.getEmail(), "bienvenida", e);
        }
    }
}

Â¿QuÃ© hace cada mÃ©todo?
- validateEmail(): Verifica que el email tenga formato vÃ¡lido
- checkEmailConfiguration(): Verifica que el email estÃ© configurado
- sendWelcomeEmail(): EnvÃ­a email de bienvenida (se ejecuta de forma asÃ­ncrona)

Â¿Por quÃ© @Async?
- Los emails NO bloquean el registro/compra
- Si el email falla, la acciÃ³n principal (registro/orden) sigue funcionando
- Mejora la experiencia del usuario (respuesta mÃ¡s rÃ¡pida)

================================================================================
ASYNCCONFIG.JAVA - HABILITAR ENVÃO ASÃNCRONO
================================================================================

@Configuration
@EnableAsync
public class AsyncConfig {
}

Â¿Para quÃ© sirve?
- Habilita la anotaciÃ³n @Async en toda la aplicaciÃ³n
- Los mÃ©todos con @Async se ejecutan en un hilo separado
- El mÃ©todo principal NO espera a que termine el email

Flujo SIN @Async:
1. Usuario hace registro
2. Crear usuario en BD (1 segundo)
3. Enviar email (3 segundos)
4. Retornar respuesta
Total: 4 segundos

Flujo CON @Async:
1. Usuario hace registro
2. Crear usuario en BD (1 segundo)
3. Iniciar envÃ­o de email en segundo plano
4. Retornar respuesta inmediatamente
Total: 1 segundo
(El email se envÃ­a en paralelo)

================================================================================
TEMPLATES HTML DE EMAILS
================================================================================

Los emails se envÃ­an en formato HTML para verse profesionales.

Estructura bÃ¡sica:
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        /* Estilos CSS inline */
        body { font-family: Arial; }
        .header { background: gradient; color: white; }
        .button { background: #color; padding: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>TÃ­tulo del Email</h1>
        </div>
        <div class="content">
            <p>Contenido personalizado</p>
            <a href="link" class="button">BotÃ³n de AcciÃ³n</a>
        </div>
    </div>
</body>
</html>

Â¿Por quÃ© HTML y no texto plano?
- âœ… Se ve mÃ¡s profesional
- âœ… Puedes usar colores, imÃ¡genes, botones
- âœ… Mejor experiencia de usuario
- âœ… Permite links clickeables

âš ï¸ IMPORTANTE:
- Los estilos deben ir INLINE (no en archivo CSS separado)
- Usa tablas para el layout (mejor compatibilidad)
- Prueba en diferentes clientes de email (Gmail, Outlook)

================================================================================
INTEGRACIÃ“N CON AUTHCONTROLLER
================================================================================

@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
public class AuthController {
    
    private final UserService userService;
    private final EmailService emailService;  // â† Inyectar
    
    @PostMapping("/register")
    public ResponseEntity<AuthResponse> register(@Valid @RequestBody RegisterRequest request) {
        // Registrar usuario
        User registered = userService.registerUser(user);
        
        // âœ… ENVIAR EMAIL (no interrumpe si falla)
        try {
            emailService.sendWelcomeEmail(registered);
        } catch (Exception e) {
            // Log error pero no interrumpir el registro
        }
        
        // Generar token y retornar
        String token = jwtUtils.generateToken(registered);
        return ResponseEntity.status(HttpStatus.CREATED).body(response);
    }
}

Â¿Por quÃ© try-catch?
- Si el email falla, el REGISTRO sigue funcionando
- El usuario NO ve error de email
- Solo se loguea el error para el desarrollador

================================================================================
INTEGRACIÃ“N CON ORDERSERVICE
================================================================================

@Service
@Transactional
@RequiredArgsConstructor
public class OrderService {
    
    private final OrderRepository orderRepository;
    private final EmailService emailService;  // â† Inyectar
    
    public Order createOrder(CreateOrderRequest request) {
        // Crear orden
        Order savedOrder = orderRepository.save(order);
        
        // âœ… ENVIAR EMAIL (asÃ­ncrono, no bloquea)
        emailService.sendOrderConfirmation(savedOrder);
        
        return savedOrder;
    }
    
    public Order updateOrderStatus(Long id, OrderStatus newStatus) {
        Order order = getOrderById(id);
        order.setStatus(newStatus);
        
        switch (newStatus) {
            case SHIPPED -> {
                order.setShippedAt(LocalDateTime.now());
                emailService.sendShippingNotification(order);  // âœ… Email
            }
            case DELIVERED -> {
                order.setDeliveredAt(LocalDateTime.now());
                emailService.sendDeliveryNotification(order);  // âœ… Email
            }
        }
        
        return orderRepository.save(order);
    }
}

================================================================================
TESTING DE EMAILS
================================================================================

PRUEBA 1: Email de Bienvenida
1. POST /api/auth/register con un email real
2. Verificar logs: "âœ… Email de bienvenida enviado a: ..."
3. Revisar bandeja de entrada (puede tardar 1-2 minutos)
4. Revisar SPAM si no aparece

PRUEBA 2: Email de ConfirmaciÃ³n de Orden
1. POST /api/orders con productos
2. Verificar logs: "âœ… Email de confirmaciÃ³n enviado para orden #X"
3. Revisar email con resumen de la orden

PRUEBA 3: Email de EnvÃ­o
1. PATCH /api/orders/1/status con status=SHIPPED
2. Verificar logs: "âœ… Email de envÃ­o enviado para orden #1"
3. Revisar email con tracking number

PRUEBA 4: Email de Entrega
1. PATCH /api/orders/1/status con status=DELIVERED
2. Verificar logs: "âœ… Email de entrega enviado para orden #1"
3. Revisar email con solicitud de reseÃ±a

================================================================================
TROUBLESHOOTING - PROBLEMAS COMUNES
================================================================================

PROBLEMA 1: "Email no configurado"
Logs: âš ï¸ ADVERTENCIA: Email no configurado
SoluciÃ³n:
- Verifica que spring.mail.username tenga tu email
- Verifica que spring.mail.password tenga la App Password
- Reinicia la aplicaciÃ³n

PROBLEMA 2: "Authentication failed"
Error: 535-5.7.8 Username and Password not accepted
SoluciÃ³n:
- Genera una NUEVA App Password
- Verifica que copiaste la contraseÃ±a SIN espacios
- Verifica que tienes verificaciÃ³n en 2 pasos activada

PROBLEMA 3: Los emails no llegan
Logs: âœ… Email enviado exitosamente
SoluciÃ³n:
- Revisa tu carpeta de SPAM
- Espera 5-10 minutos (Gmail puede tardar)
- Busca en Gmail: from:tu-email@gmail.com
- Verifica que app.email.from use tu email real de Gmail

PROBLEMA 4: "Invalid email"
Error: InvalidEmailException
SoluciÃ³n:
- Verifica el formato del email
- No debe tener espacios
- Debe tener @ y dominio vÃ¡lido

PROBLEMA 5: Gmail bloquea el email
SoluciÃ³n:
- NO uses email "from" diferente a tu Gmail
- Cambiar app.email.from=tu-email@gmail.com (sin nombre)
- Genera nueva App Password
- Verifica configuraciÃ³n de seguridad de Gmail

PROBLEMA 6: Email se ve mal (sin estilos)
SoluciÃ³n:
- Los estilos CSS deben ir INLINE en el HTML
- Usa tablas para el layout
- Prueba en diferentes clientes de email

PROBLEMA 7: "Service Unavailable (503)"
SoluciÃ³n:
- Verifica conexiÃ³n a internet
- Verifica que Gmail no estÃ© bloqueando
- Revisa logs para ver el error exacto

================================================================================
MEJORES PRÃCTICAS
================================================================================

âœ… SIEMPRE usar @Async para envÃ­o de emails
   - No bloquea el flujo principal
   - Mejor experiencia de usuario

âœ… SIEMPRE manejar excepciones de email
   - No interrumpir registro/compra si falla el email
   - Loguear errores para debugging

âœ… SIEMPRE validar formato de email
   - Evita errores de envÃ­o
   - Mejor UX con mensajes claros

âœ… SIEMPRE usar HTML en emails
   - MÃ¡s profesional
   - Mejor legibilidad

âœ… NUNCA exponer errores de email al usuario
   - Solo loguear en servidor
   - Usuario no debe ver detalles tÃ©cnicos

âœ… NUNCA usar contraseÃ±a normal de Gmail
   - Solo App Password
   - MÃ¡s seguro

âœ… NUNCA enviar emails sÃ­ncronos
   - Siempre usar @Async
   - Evita timeouts

================================================================================
RESUMEN
================================================================================

Sistema de Emails implementado:
1. âœ… ConfiguraciÃ³n de Gmail con App Password
2. âœ… EmailService con 4 tipos de emails
3. âœ… 3 excepciones personalizadas
4. âœ… EnvÃ­o asÃ­ncrono con @Async
5. âœ… Templates HTML profesionales
6. âœ… IntegraciÃ³n con AuthController y OrderService
7. âœ… Manejo robusto de errores
8. âœ… ValidaciÃ³n de emails
9. âœ… Troubleshooting completo

Emails implementados:
- ğŸ“§ Bienvenida (al registrarse)
- ğŸ“§ ConfirmaciÃ³n de orden (al crear orden)
- ğŸ“§ NotificaciÃ³n de envÃ­o (al marcar SHIPPED)
- ğŸ“§ NotificaciÃ³n de entrega (al marcar DELIVERED)
- ğŸ“§ RecuperaciÃ³n de contraseÃ±a (al solicitar reset)

================================================================================
                            FIN DE APUNTES
================================================================================
