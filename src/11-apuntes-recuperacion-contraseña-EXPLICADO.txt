================================================================================
         11 - RECUPERACIÃ“N DE CONTRASEÃ‘A (EXPLICADO PASO A PASO)
                         E-COMMERCE DE JOYERÃA
================================================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              Â¿QUÃ‰ ES LA RECUPERACIÃ“N DE CONTRASEÃ‘A?                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SITUACIÃ“N COMÃšN:
MarÃ­a comprÃ³ joyas por $15,000 en tu tienda hace 2 meses.
Hoy quiere ver el estado de su pedido pero...
âŒ OlvidÃ³ su contraseÃ±a
âŒ No puede entrar a su cuenta
âŒ EstÃ¡ frustrada

SIN RECUPERACIÃ“N:
MarÃ­a: "OlvidÃ© mi contraseÃ±a, Â¿quÃ© hago?"
OpciÃ³n 1: Llamar a soporte â†’ Esperar 30 minutos â†’ Explicar todo
OpciÃ³n 2: Crear cuenta nueva â†’ Perder historial de compras
Resultado: Cliente molesto, posible pÃ©rdida del cliente

CON RECUPERACIÃ“N (AUTOMÃTICA):
1. MarÃ­a: Click en "OlvidÃ© mi contraseÃ±a"
2. MarÃ­a: Ingresa su email
3. Sistema: EnvÃ­a email con link especial
4. MarÃ­a: Click en el link â†’ Crea nueva contraseÃ±a
5. MarÃ­a: Entra a su cuenta felizmente
Resultado: Cliente feliz, 0 llamadas al soporte, problema resuelto en 2 minutos

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ANALOGÃA DEL CASILLERO                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Imagina que tienes un casillero con combinaciÃ³n numÃ©rica:

ESCENARIO 1: Olvidaste la combinaciÃ³n
â†’ Llamas al encargado
â†’ Ã‰l te da una "LLAVE TEMPORAL" que:
  âœ“ Solo funciona UNA VEZ
  âœ“ Solo funciona por 1 HORA
  âœ“ Solo TÃš la tienes (te la dio personalmente)
â†’ Usas la llave temporal
â†’ Cambias la combinaciÃ³n a una nueva
â†’ La llave temporal deja de funcionar
â†’ Ahora solo tu nueva combinaciÃ³n funciona

ESTO ES EXACTAMENTE lo que hace la recuperaciÃ³n de contraseÃ±a:
- Llave temporal = TOKEN (cÃ³digo Ãºnico)
- 1 hora = EXPIRACIÃ“N
- Una vez = NO REUTILIZABLE
- Cambiar combinaciÃ³n = NUEVA CONTRASEÃ‘A

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    FLUJO COMPLETO (11 PASOS)                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PASO 1: Usuario hace click en "OlvidÃ© mi contraseÃ±a"
        â””â†’ En el frontend (tu pÃ¡gina web)

PASO 2: Usuario ingresa su email en un formulario
        â””â†’ Ejemplo: maria@email.com

PASO 3: Frontend envÃ­a request al backend
        â””â†’ POST /api/auth/forgot-password
        â””â†’ Body: { "email": "maria@email.com" }

PASO 4: Backend busca el usuario en la base de datos
        â””â†’ Â¿Existe maria@email.com? 
        â””â†’ SÃ­ existe â†’ Continuar
        â””â†’ No existe â†’ Mensaje genÃ©rico (por seguridad)

PASO 5: Backend genera un TOKEN Ãºnico
        â””â†’ UUID.randomUUID() = "a1b2c3d4-e5f6-g7h8-..."
        â””â†’ Este token es IMPOSIBLE de adivinar

PASO 6: Backend guarda el token en la BD
        â””â†’ Tabla: password_reset_tokens
        â””â†’ Campos: token, user_id, expiry_date, used
        â””â†’ expiry_date = ahora + 1 hora

PASO 7: Backend envÃ­a EMAIL a maria@email.com
        â””â†’ Contiene: Link con el token
        â””â†’ Ejemplo: https://mitienda.com/reset?token=a1b2c3d4...

PASO 8: MarÃ­a recibe el email y hace click en el link
        â””â†’ Esto la lleva al frontend

PASO 9: Frontend muestra formulario para nueva contraseÃ±a
        â””â†’ MarÃ­a ingresa: "nuevapass123"

PASO 10: Frontend envÃ­a request al backend
         â””â†’ POST /api/auth/reset-password
         â””â†’ Body: { "token": "a1b2c3d4...", "newPassword": "nuevapass123" }

PASO 11: Backend valida y cambia la contraseÃ±a
         â”œâ†’ Â¿Token existe? âœ“
         â”œâ†’ Â¿Token no expirÃ³? âœ“
         â”œâ†’ Â¿Token no fue usado? âœ“
         â”œâ†’ Encripta "nuevapass123" con BCrypt
         â”œâ†’ Actualiza contraseÃ±a de MarÃ­a
         â”œâ†’ Marca token como "usado"
         â””â†’ Â¡Listo! MarÃ­a puede hacer login con su nueva contraseÃ±a

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ENTIDAD: PASSWORDRESETTOKEN                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Â¿QUÃ‰ ES UNA ENTIDAD?
Una entidad es una tabla en la base de datos. Cada fila es un registro.

ESTA ENTIDAD:
Guarda los tokens temporales de recuperaciÃ³n de contraseÃ±a.

@Entity
@Table(name = "password_reset_tokens")
public class PasswordResetToken {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;  â† ID Ãºnico de este token
    
    @Column(nullable = false, unique = true)
    private String token;  â† El token generado (UUID)
    
    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;  â† Â¿Para quÃ© usuario es este token?
    
    @Column(nullable = false)
    private LocalDateTime expiryDate;  â† Â¿CuÃ¡ndo expira? (1 hora despuÃ©s)
    
    @Column(nullable = false)
    private Boolean used = false;  â† Â¿Ya se usÃ³? (para evitar reutilizaciÃ³n)
    
    @Column(nullable = false)
    private LocalDateTime createdAt = LocalDateTime.now();  â† Â¿CuÃ¡ndo se creÃ³?
    
    // MÃ©todo helper
    public boolean isExpired() {
        return LocalDateTime.now().isAfter(expiryDate);
    }
    
    // MÃ©todo helper
    public boolean isValid() {
        return !used && !isExpired();
    }
}

EXPLICACIÃ“N CAMPO POR CAMPO:

id: 1, 2, 3, 4...
    Â¿Para quÃ©? Identificar cada token de forma Ãºnica en la BD

token: "a1b2c3d4-e5f6-g7h8-i9j0-k1l2m3n4o5p6"
    Â¿Para quÃ©? Es la "llave temporal". Se envÃ­a en el email.
    Â¿Por quÃ© UUID? Porque es imposible de adivinar (36 caracteres aleatorios)

user: MarÃ­a (relaciÃ³n con tabla users)
    Â¿Para quÃ©? Saber a quÃ© usuario pertenece este token
    Si el token es vÃ¡lido, sabemos que es de MarÃ­a

expiryDate: 2026-02-27 15:30:00
    Â¿Para quÃ©? DespuÃ©s de esta fecha, el token NO funciona
    Â¿Por quÃ© 1 hora? Balance entre comodidad y seguridad

used: false
    Â¿Para quÃ©? Una vez usado, se marca true para evitar que se use de nuevo
    Es como una llave que se rompe despuÃ©s de usarla una vez

createdAt: 2026-02-27 14:30:00
    Â¿Para quÃ©? Registro de cuÃ¡ndo se generÃ³ (Ãºtil para auditorÃ­a)

MÃ‰TODOS HELPER:

isExpired(): 
    Pregunta: "Â¿Ya pasÃ³ 1 hora?"
    Respuesta: true (expirÃ³) o false (aÃºn vÃ¡lido)

isValid():
    Pregunta: "Â¿Este token se puede usar?"
    Respuesta: Solo si NO se usÃ³ Y NO expirÃ³

EJEMPLO DE REGISTRO EN LA BD:

id  | token             | user_id | expiry_date         | used  | created_at
----|-------------------|---------|---------------------|-------|-------------------
1   | a1b2c3d4-e5f6...  | 5       | 2026-02-27 15:30:00 | false | 2026-02-27 14:30:00
2   | x9y8z7w6-v5u4...  | 12      | 2026-02-27 16:00:00 | true  | 2026-02-27 15:00:00
                                                         â†‘
                                                    Ya se usÃ³ (no se puede reutilizar)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    SERVICE: PASSWORDRESETSERVICE                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Este servicio tiene toda la LÃ“GICA de negocio de la recuperaciÃ³n.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MÃ‰TODO 1: requestPasswordReset()                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â¿QUÃ‰ HACE? Genera un token y envÃ­a el email

public void requestPasswordReset(String email) {
    
    // 1. Buscar usuario en BD
    User user = userRepository.findByEmail(email)
            .orElseThrow(() -> new ResourceNotFoundException("User", "email", email));
    // Â¿Por quÃ©? Necesitamos verificar que el email existe
    
    // 2. Borrar tokens anteriores de este usuario
    tokenRepository.deleteByUser(user);
    // Â¿Por quÃ©? Si MarÃ­a ya pidiÃ³ un reset antes, ese token viejo ya no sirve
    // Solo el MÃS RECIENTE es vÃ¡lido
    
    // 3. Generar nuevo token Ãºnico
    String token = UUID.randomUUID().toString();
    // Resultado: "a1b2c3d4-e5f6-g7h8-i9j0-k1l2m3n4o5p6"
    
    // 4. Crear registro del token
    PasswordResetToken resetToken = new PasswordResetToken();
    resetToken.setToken(token);
    resetToken.setUser(user);
    resetToken.setExpiryDate(LocalDateTime.now().plusHours(1));  â† Expira en 1 hora
    resetToken.setUsed(false);  â† AÃºn no se ha usado
    
    // 5. Guardar en BD
    tokenRepository.save(resetToken);
    
    // 6. Enviar email con el token
    emailService.sendPasswordResetEmail(user, token);
    // Este email contiene el link: https://mitienda.com/reset?token=a1b2c3d4...
}

PREGUNTA: Â¿Por quÃ© borrar tokens anteriores?

RESPUESTA:
MarÃ­a pidiÃ³ reset â†’ Token 1 generado
MarÃ­a cerrÃ³ el email por error
MarÃ­a pide reset de nuevo â†’ Token 2 generado

Sin borrar: Token 1 Y Token 2 funcionan (confusiÃ³n)
Borrando: Solo Token 2 funciona (el mÃ¡s reciente)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MÃ‰TODO 2: validateResetToken()                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â¿QUÃ‰ HACE? Verifica si un token es vÃ¡lido

public User validateResetToken(String token) {
    
    // 1. Buscar el token en BD
    PasswordResetToken resetToken = tokenRepository.findByToken(token)
            .orElseThrow(() -> new InvalidTokenException("Token no encontrado"));
    // Â¿Por quÃ©? Si el token no existe en BD, es invÃ¡lido
    
    // 2. Verificar si ya se usÃ³
    if (resetToken.getUsed()) {
        throw new InvalidTokenException("Este token ya fue utilizado");
    }
    // Â¿Por quÃ©? No puedes usar la misma "llave temporal" dos veces
    
    // 3. Verificar si expirÃ³
    if (resetToken.isExpired()) {
        throw new TokenExpiredException();
    }
    // Â¿Por quÃ©? Si pasÃ³ mÃ¡s de 1 hora, el token ya no sirve
    
    // 4. Si todo estÃ¡ bien, retornar el usuario
    return resetToken.getUser();
}

CASOS DE USO:

CASO 1: Token correcto, no usado, no expirado
Resultado: âœ… Retorna el usuario (MarÃ­a)

CASO 2: Token ya fue usado antes
Resultado: âŒ InvalidTokenException: "Este token ya fue utilizado"

CASO 3: Token expirÃ³ (pasÃ³ mÃ¡s de 1 hora)
Resultado: âŒ TokenExpiredException: "El token ha expirado"

CASO 4: Token no existe en BD (alguien lo inventÃ³)
Resultado: âŒ InvalidTokenException: "Token no encontrado"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MÃ‰TODO 3: resetPassword()                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â¿QUÃ‰ HACE? Cambia la contraseÃ±a del usuario

public void resetPassword(String token, String newPassword) {
    
    // 1. Buscar el token
    PasswordResetToken resetToken = tokenRepository.findByToken(token)
            .orElseThrow(() -> new InvalidTokenException("Token no encontrado"));
    
    // 2. Validar (igual que validateResetToken)
    if (resetToken.getUsed()) {
        throw new InvalidTokenException("Este token ya fue utilizado");
    }
    if (resetToken.isExpired()) {
        throw new TokenExpiredException();
    }
    
    // 3. Obtener el usuario
    User user = resetToken.getUser();
    
    // 4. CAMBIAR LA CONTRASEÃ‘A (encriptada con BCrypt)
    user.setPassword(passwordEncoder.encode(newPassword));
    userRepository.save(user);
    // Â¿Por quÃ© BCrypt? NUNCA guardamos contraseÃ±as en texto plano
    // BCrypt genera un hash irreversible
    
    // 5. Marcar token como usado (para que no se pueda usar de nuevo)
    resetToken.setUsed(true);
    tokenRepository.save(resetToken);
    
    // Â¡Listo! MarÃ­a ya puede hacer login con su nueva contraseÃ±a
}

FLUJO VISUAL:

MarÃ­a ingresa: "nuevapass123"
                    â†“
passwordEncoder.encode("nuevapass123")
                    â†“
"$2a$10$Xj8fK..." (hash BCrypt, 60 caracteres)
                    â†“
Se guarda en BD (columna password)
                    â†“
Token se marca como used=true
                    â†“
MarÃ­a puede hacer login con "nuevapass123"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MÃ‰TODO 4: cleanExpiredTokens() [AUTOMÃTICO]                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â¿QUÃ‰ HACE? Limpia tokens viejos de la BD (mantenimiento)

@Scheduled(cron = "0 0 * * * *")  â† Se ejecuta cada hora
public void cleanExpiredTokens() {
    LocalDateTime now = LocalDateTime.now();
    tokenRepository.deleteByExpiryDateBefore(now);
}

Â¿QUÃ‰ ES @Scheduled?
Es como poner una alarma que ejecuta este mÃ©todo automÃ¡ticamente.

CRON EXPRESSION: "0 0 * * * *"
Desglose: segundo minuto hora dÃ­a mes dÃ­aDeLaSemana
          0       0      *   *   *    *
          â†‘       â†‘      â†‘
          0       0    Cada hora

Significado: "Ejecuta cada hora en punto (13:00, 14:00, 15:00...)"

Â¿POR QUÃ‰ ES NECESARIO?
Sin limpieza: BD se llena de tokens viejos e inÃºtiles
Con limpieza: BD limpia, mejor rendimiento

EJEMPLO:
Hora actual: 15:00

Tokens en BD:
- Token 1: expiryDate = 14:00 (expirÃ³ hace 1 hora) â†’ SE BORRA
- Token 2: expiryDate = 14:30 (expirÃ³ hace 30 min) â†’ SE BORRA
- Token 3: expiryDate = 15:30 (expira en 30 min) â†’ SE MANTIENE
- Token 4: expiryDate = 16:00 (expira en 1 hora) â†’ SE MANTIENE

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    EXCEPCIONES PERSONALIZADAS                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Creamos 2 excepciones especÃ­ficas para tokens:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EXCEPCIÃ“N 1: InvalidTokenException                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CUÃNDO SE LANZA:
- Token no existe en BD
- Token ya fue usado
- Token tiene formato invÃ¡lido

EJEMPLO DE USO:
MarÃ­a intenta usar el mismo token 2 veces
â†’ Primera vez: âœ… Funciona, contraseÃ±a cambiada
â†’ Segunda vez: âŒ InvalidTokenException: "Este token ya fue utilizado"

CÃ“DIGO:
public class InvalidTokenException extends RuntimeException {
    public InvalidTokenException(String message) {
        super(message);
    }
}

HTTP STATUS: 400 Bad Request

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EXCEPCIÃ“N 2: TokenExpiredException                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CUÃNDO SE LANZA:
- Han pasado mÃ¡s de 1 hora desde que se generÃ³ el token

EJEMPLO DE USO:
MarÃ­a recibe el email a las 14:00
MarÃ­a abre el email a las 15:30 (1.5 horas despuÃ©s)
MarÃ­a hace click en el link
â†’ âŒ TokenExpiredException: "El token ha expirado. Solicita uno nuevo."

CÃ“DIGO:
public class TokenExpiredException extends RuntimeException {
    public TokenExpiredException() {
        super("El token ha expirado. Por favor, solicita uno nuevo.");
    }
}

HTTP STATUS: 400 Bad Request

PREGUNTA: Â¿Por quÃ© excepciones separadas?

RESPUESTA:
Mensajes diferentes para el usuario:
- "Token invÃ¡lido" â†’ Algo saliÃ³ mal con el token
- "Token expirado" â†’ Tardaste mucho, pide uno nuevo

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ENDPOINTS EN AUTHCONTROLLER                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ENDPOINT 1: POST /api/auth/forgot-password                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â¿QUÃ‰ HACE? Usuario solicita recuperar su contraseÃ±a

REQUEST:
POST http://localhost:8080/api/auth/forgot-password
Body: {
  "email": "maria@email.com"
}

CÃ“DIGO:
@PostMapping("/forgot-password")
public ResponseEntity<MessageResponse> forgotPassword(
        @Valid @RequestBody ForgotPasswordRequest request
) {
    passwordResetService.requestPasswordReset(request.getEmail());
    
    return ResponseEntity.ok(new MessageResponse(
        "Si el email existe, recibirÃ¡s instrucciones"
    ));
}

PREGUNTA: Â¿Por quÃ© "Si el email existe" y no decir claramente?

RESPUESTA (SEGURIDAD):
Mensaje claro: "Email no encontrado"
â†’ Hacker sabe que maria@email.com NO existe
â†’ Hacker sabe que pedro@email.com SÃ existe
â†’ Hacker puede hacer lista de usuarios reales

Mensaje genÃ©rico: "Si el email existe..."
â†’ Hacker NO sabe si el email existe o no
â†’ Previene enumerar usuarios

RESPONSE:
Status: 200 OK
Body: {
  "message": "Si el email existe, recibirÃ¡s instrucciones..."
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ENDPOINT 2: POST /api/auth/reset-password                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â¿QUÃ‰ HACE? Usuario cambia su contraseÃ±a con el token

REQUEST:
POST http://localhost:8080/api/auth/reset-password
Body: {
  "token": "a1b2c3d4-e5f6-g7h8-i9j0-k1l2m3n4o5p6",
  "newPassword": "nuevapass123"
}

CÃ“DIGO:
@PostMapping("/reset-password")
public ResponseEntity<MessageResponse> resetPassword(
        @Valid @RequestBody ResetPasswordRequest request
) {
    passwordResetService.resetPassword(request.getToken(), request.getNewPassword());
    
    return ResponseEntity.ok(new MessageResponse(
        "ContraseÃ±a restablecida exitosamente"
    ));
}

RESPONSE EXITOSA:
Status: 200 OK
Body: {
  "message": "ContraseÃ±a restablecida exitosamente"
}

RESPONSE CON ERROR (token invÃ¡lido):
Status: 400 Bad Request
Body: {
  "status": 400,
  "error": "Invalid Token",
  "message": "Este token ya fue utilizado"
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ENDPOINT 3: GET /api/auth/validate-reset-token/{token}                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â¿QUÃ‰ HACE? Verifica si un token es vÃ¡lido (OPCIONAL)

Este endpoint es Ãºtil para el frontend:
Cuando el usuario abre el link del email, el frontend puede verificar
si el token es vÃ¡lido ANTES de mostrar el formulario.

REQUEST:
GET http://localhost:8080/api/auth/validate-reset-token/a1b2c3d4...

CÃ“DIGO:
@GetMapping("/validate-reset-token/{token}")
public ResponseEntity<MessageResponse> validateResetToken(@PathVariable String token) {
    passwordResetService.validateResetToken(token);
    return ResponseEntity.ok(new MessageResponse("Token vÃ¡lido"));
}

CASO 1: Token vÃ¡lido
Status: 200 OK
Body: { "message": "Token vÃ¡lido" }
â†’ Frontend muestra formulario

CASO 2: Token invÃ¡lido
Status: 400 Bad Request
Body: { "message": "Token invÃ¡lido o expirado" }
â†’ Frontend muestra mensaje de error y botÃ³n "Solicitar nuevo token"

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    EMAIL DE RECUPERACIÃ“N                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

El email que recibe el usuario contiene:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RecuperaciÃ³n de ContraseÃ±a ğŸ”                                           â”‚
â”‚                                                                          â”‚
â”‚  Hola MarÃ­a,                                                             â”‚
â”‚                                                                          â”‚
â”‚  Recibimos una solicitud para cambiar tu contraseÃ±a.                    â”‚
â”‚                                                                          â”‚
â”‚  [BOTÃ“N GRANDE: Restablecer ContraseÃ±a]                                 â”‚
â”‚  â†’ Link: https://mitienda.com/reset-password?token=a1b2c3d4...          â”‚
â”‚                                                                          â”‚
â”‚  O copia este enlace en tu navegador:                                   â”‚
â”‚  https://mitienda.com/reset-password?token=a1b2c3d4...                  â”‚
â”‚                                                                          â”‚
â”‚  âš ï¸ IMPORTANTE:                                                          â”‚
â”‚  â€¢ Este enlace expira en 1 HORA                                         â”‚
â”‚  â€¢ Solo puedes usarlo UNA VEZ                                           â”‚
â”‚  â€¢ Si no fuiste tÃº, ignora este email                                   â”‚
â”‚                                                                          â”‚
â”‚  Â¿Problemas? ContÃ¡ctanos: soporte@joyeria.com                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ELEMENTOS CLAVE:

1. Saludo personalizado: "Hola MarÃ­a"
   â†’ Genera confianza

2. BotÃ³n grande y visible
   â†’ FÃ¡cil de hacer click

3. Link alternativo
   â†’ Por si el botÃ³n no funciona en su cliente de email

4. Advertencias claras
   â†’ Usuario sabe que tiene 1 hora
   â†’ Usuario sabe que es de un solo uso

5. Nota de seguridad
   â†’ "Si no fuiste tÃº, ignora"
   â†’ Tranquiliza al usuario si no fue Ã©l

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    SEGURIDAD IMPLEMENTADA                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… TOKENS ÃšNICOS (UUID)
   - 36 caracteres aleatorios
   - Probabilidad de colisiÃ³n: 1 en 5.316Ã—10Â³â¶
   - IMPOSIBLE de adivinar

âœ… EXPIRACIÃ“N (1 hora)
   - Ventana de tiempo limitada
   - Si alguien intercepta el email despuÃ©s, no funciona

âœ… USO ÃšNICO
   - Token se marca como "used" despuÃ©s del primer uso
   - No se puede reutilizar

âœ… TOKENS ANTERIORES INVALIDADOS
   - Si pides reset 2 veces, solo el Ãºltimo funciona
   - Evita acumulaciÃ³n de tokens vÃ¡lidos

âœ… MENSAJE GENÃ‰RICO
   - No revela si un email existe en la BD
   - Previene enumeraciÃ³n de usuarios

âœ… CONTRASEÃ‘A ENCRIPTADA (BCrypt)
   - NUNCA se guarda en texto plano
   - Hash de una vÃ­a (irreversible)

âœ… LIMPIEZA AUTOMÃTICA
   - Tokens expirados se borran cada hora
   - BD limpia y eficiente

âš ï¸ IMPORTANTE EN PRODUCCIÃ“N:
- SIEMPRE usa HTTPS (los tokens viajan en URLs)
- En desarrollo (localhost) no es crÃ­tico
- En producciÃ³n SIN https = INSEGURO

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    TESTING PASO A PASO                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PRUEBA COMPLETA EN POSTMAN:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 1: Solicitar recuperaciÃ³n                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POST http://localhost:8080/api/auth/forgot-password
Body: {
  "email": "tu-email@gmail.com"
}

âœ… Response esperado:
{
  "message": "Si el email existe, recibirÃ¡s instrucciones..."
}

âœ… Verificar:
- Revisa tu email (puede tardar 1-2 minutos)
- Revisa SPAM si no llega
- Logs del servidor: "âœ… Token generado para: tu-email@gmail.com"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 2: Copiar token del email                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Abre el email que recibiste
Busca el link: https://...?token=a1b2c3d4-e5f6...
COPIA el token (la parte despuÃ©s de ?token=)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 3: Validar token (OPCIONAL)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GET http://localhost:8080/api/auth/validate-reset-token/a1b2c3d4...
                                                         â†‘
                                            Pega el token aquÃ­

âœ… Response esperado:
{
  "message": "Token vÃ¡lido"
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 4: Cambiar contraseÃ±a                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POST http://localhost:8080/api/auth/reset-password
Body: {
  "token": "a1b2c3d4-e5f6-g7h8...",  â† El token del email
  "newPassword": "nuevapass123"
}

âœ… Response esperado:
{
  "message": "ContraseÃ±a restablecida exitosamente"
}

âœ… Verificar logs:
"âœ… ContraseÃ±a restablecida para: tu-email@gmail.com"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 5: Login con nueva contraseÃ±a                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POST http://localhost:8080/api/auth/login
Body: {
  "email": "tu-email@gmail.com",
  "password": "nuevapass123"  â† La nueva contraseÃ±a
}

âœ… Response esperado:
{
  "token": "eyJhbGciOiJIUzI1...",
  "email": "tu-email@gmail.com"
}

Â¡LOGIN EXITOSO! ğŸ‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PRUEBA ADICIONAL: Intentar reutilizar token                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POST http://localhost:8080/api/auth/reset-password
Body: {
  "token": "EL-MISMO-TOKEN-DE-ANTES",
  "newPassword": "otra123"
}

âŒ Response esperado:
{
  "status": 400,
  "error": "Invalid Token",
  "message": "Este token ya fue utilizado"
}

Â¡CORRECTO! El token no se puede reutilizar ğŸ”’

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    PROBLEMAS COMUNES Y SOLUCIONES                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEMA 1: Email no llega
â†’ Revisa SPAM
â†’ Espera 5-10 minutos
â†’ Verifica configuraciÃ³n de email (apuntes 10)
â†’ Revisa logs: "âœ… Email de recuperaciÃ³n enviado"

PROBLEMA 2: "Token no encontrado"
â†’ Copiaste mal el token (espacios extra, caracteres faltantes)
â†’ Token expirÃ³ (pasÃ³ mÃ¡s de 1 hora)
â†’ Solicita un nuevo token

PROBLEMA 3: @Scheduled no funciona
â†’ Falta @EnableScheduling en clase principal
â†’ Verificar: JoyeriaApiApplication.java debe tener @EnableScheduling

PROBLEMA 4: Tokens no se borran de BD
â†’ Verificar que @EnableScheduling estÃ¡ activo
â†’ Verificar cron expression: "0 0 * * * *"
â†’ Ejecutar manualmente en Postman (crear endpoint de prueba)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           RESUMEN FINAL                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LO QUE APRENDIMOS:

âœ… QuÃ© es recuperaciÃ³n de contraseÃ±a (la "llave temporal")
âœ… Flujo completo de 11 pasos
âœ… Entidad PasswordResetToken (quÃ© guarda y por quÃ©)
âœ… Service con 4 mÃ©todos (generar, validar, resetear, limpiar)
âœ… 2 excepciones (InvalidToken, TokenExpired)
âœ… 3 endpoints (forgot, reset, validate)
âœ… Email HTML con link temporal
âœ… 7 capas de seguridad implementadas
âœ… Testing completo paso a paso
âœ… Troubleshooting de problemas comunes

ARCHIVOS CREADOS/MODIFICADOS:
- model/PasswordResetToken.java (entidad)
- repository/PasswordResetTokenRepository.java
- exception/InvalidTokenException.java
- exception/TokenExpiredException.java
- service/PasswordResetService.java
- dto/ForgotPasswordRequest.java
- dto/ResetPasswordRequest.java
- dto/MessageResponse.java
- controller/AuthController.java (3 endpoints nuevos)
- service/EmailService.java (nuevo mÃ©todo)
- JoyeriaApiApplication.java (@EnableScheduling)

BENEFICIOS:
âœ… Usuarios pueden recuperar acceso por sÃ­ mismos
âœ… 0 llamadas al soporte por contraseÃ±as olvidadas
âœ… Proceso seguro con mÃºltiples validaciones
âœ… Experiencia de usuario fluida y rÃ¡pida

================================================================================
                            FIN DE APUNTES
================================================================================
